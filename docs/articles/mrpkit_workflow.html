<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started with mrpkit • mrpkit</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started with mrpkit">
<meta property="og:description" content="mrpkit">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mrpkit</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Objects and Methods</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mrpkit_workflow.html">Getting Started</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mitzimorris/mrp-kit">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mrpkit_workflow_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="mrpkit_workflow_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="mrpkit_workflow_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting Started with mrpkit</h1>
            
      
      
      <div class="hidden name"><code>mrpkit_workflow.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mrpkit</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></pre></div>
<p>This vignette presents the typical workflow of <code>mrpkit</code>, an R package for implementing a multilevel regression with post-stratification.</p>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The aim of <code>mrpkit</code> is to perform multilevel regression with post-stratification (MRP; Gelman &amp; Little, 1997; Park, Gelman, &amp; Bafumi, 2004). By using this package, you follow a specific workflow of MRP from creating the metadata of the survey and post-stratification objects, mapping these objects to each other, fitting the model, getting predictions, aggregating values, and visualizing the results. Hence, it creates a more reproducible and accountable environment for conducting MRP.</p>
<p>Unlike many R packages, <code>mrpkit</code> uses <a href="https://adv-r.hadley.nz/r6.html">R6 objects</a> (Chang, 2019). Thus, instead of calling a function to perform a task, we call a method embedded in an object using <code>object$method</code>. Typical usage of this package will create four objects: <code>SurveyData</code>, <code>QuestionMap</code>, <code>SurveyMap</code>, and <code>SurveyFit</code>. There are several methods in each of these objects that will be explained later in this vignette.</p>
</div>
<div id="workflow" class="section level1">
<h1 class="hasAnchor">
<a href="#workflow" class="anchor"></a>Workflow</h1>
<p>The workflow to use <code>mrpkit</code> to implement MRP is:</p>
<ol style="list-style-type: decimal">
<li>Prepare the data.</li>
<li>Create <code>SurveyData</code>.</li>
<li>Match the values between the survey and post-stratification datasets for each question.</li>
<li>Map the questions between the survey and post-stratification datasets.</li>
<li>Fit the model.</li>
<li>Predict the probability of the outcome using the post-stratification dataset.</li>
<li>Estimate the probability of the outcome at a level of interest, for example, state/province level.</li>
<li>Visualize the probability of the outcome.</li>
</ol>
<p>A more detailed example of this workflow follows.</p>
<div id="prepare-the-data" class="section level2">
<h2 class="hasAnchor">
<a href="#prepare-the-data" class="anchor"></a>Prepare the data</h2>
<p>In this vignette, we use simulated survey and post-stratification datasets. These datasets display the preference of voters to the Box Party (BP), a political party in a fake country, Shape World, along with demographic variables. The population is designed using <code>declare_population</code> from <code>DeclareDesign</code> (Blair, Cooper, Coppock, &amp; Humphreys, 2019) to set the features in the population.</p>
<p>We can see every variable in the survey data as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">)</span>
<span class="co">#&gt;     age gender     vote_for   highest_educ   state   y        wt</span>
<span class="co">#&gt; 1 56-65   male           BP   some college State D  no  79.90290</span>
<span class="co">#&gt; 2 46-55   male Circle Party 4-year college State B yes  89.12213</span>
<span class="co">#&gt; 3 36-45   male Circle Party     associates State D  no  92.90569</span>
<span class="co">#&gt; 4 18-25   male    Box Party    high school State B yes  80.78384</span>
<span class="co">#&gt; 5 56-65 female           BP    high school State A yes  89.85756</span>
<span class="co">#&gt; 6 56-65 female Circle Party 4-year college State B yes 117.04200</span></pre></div>
<p>Additionally, the approximate population can be seen as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">)</span>
<span class="co">#&gt;   age_group gender vote_pref        wt       education state</span>
<span class="co">#&gt; 1       66+      m        BP  6.007461 4-years college     A</span>
<span class="co">#&gt; 2     56-65      f        CP  8.465851     high school     A</span>
<span class="co">#&gt; 3     56-65      m        CP  4.098878 4-years college     C</span>
<span class="co">#&gt; 4       66+      m        BP  3.883250 4-years college     C</span>
<span class="co">#&gt; 5       66+      f        CP 16.179562    some college     B</span>
<span class="co">#&gt; 6     18-35      m        BP  3.851837     high school     D</span></pre></div>
</div>
<div id="create-a-surveydata-object" class="section level2">
<h2 class="hasAnchor">
<a href="#create-a-surveydata-object" class="anchor"></a>Create a <code>SurveyData</code> object</h2>
<p><code>SurveyData</code> objects are used to represent both the survey and the post-stratification datasets, along with their metadata. The survey metadata consists of the survey’s variables, the questions that were asked, and the levels of the responses. It is also optionally to include the survey weight and its design formula to this object.</p>
<p>The most important methods for <code>SurveyData</code> objects are <code>SurveyData$new</code> and <code>SurveyData$print</code>. The <code>SurveyData$new</code> method is used to transform a regular data frame to a <code>SurveyData</code> object, whereas <code>SurveyData$print</code> is used to print the created <code>SurveyData</code> object.</p>
<p>In this example, we will show the steps to create the <code>SurveyData</code> object using the <code>SurveyData$new</code> method. <code>SurveyData$new</code> takes the argument of the metadata as mentioned previously, which are:</p>
<ol style="list-style-type: decimal">
<li>
<code>data</code> : Data frame, i.e., survey or post-stratification data that would be transformed to a <code>SurveyData</code> object. Note that this method will automatically use each of the factor, character, and binary variables to create questions and responses if you do not specify the list of questions and responses. After <code>SurveyData</code> is initialized, we can print it using the <code>print</code> method as shown below.</li>
<li>
<code>questions</code>: The question asked in the questionnaire for each of those columns.</li>
<li>
<code>responses</code>: Allowed response for each question.</li>
<li>
<code>weights</code>: This is an optional argument of the survey or post-stratification/population weight. If the weight is specified as a column in the datasets, then this argument should be specify as string data type. in this case, it is “wt” for <code>shape_survey</code> and <code>approx_voters_popn</code>. Another example is if the population is summarized as a post-stratification matrix already, then the weight would be the size of each cell, denote by <span class="math inline">\(N_j\)</span>. Further, if the entire individual level population is given, the the this argument should be omitted and it would be automatically specify as 1.</li>
<li>
<code>design</code>: This is an optional argument of the design formula of the survey, specified using the <code>survey</code> (Lumley, 2020) package notation.</li>
</ol>
<div id="create-the-surveydata-object-for-the-survey-data-set" class="section level4">
<h4 class="hasAnchor">
<a href="#create-the-surveydata-object-for-the-survey-data-set" class="anchor"></a>Create the <code>SurveyData</code> object for the survey data set</h4>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">box_pref</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SurveyData.html">SurveyData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">shape_survey</span>,
  questions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="st">"Please identify your age group"</span>,
                gender <span class="op">=</span> <span class="st">"Please select your gender"</span>,
                vote_for <span class="op">=</span> <span class="st">"Which party did you vote for in the 2018 election?"</span>,
                highest_educ <span class="op">=</span> <span class="st">"Please identify your completed highest education"</span>,
                state <span class="op">=</span> <span class="st">"Which State do you live in?"</span>,
                y <span class="op">=</span> <span class="st">"If today is election day, will you vote for the Box Party?"</span><span class="op">)</span>,
  responses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>age <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">$</span><span class="va">age</span><span class="op">)</span>,
                   gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span>,
                   vote_for <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">$</span><span class="va">vote_for</span><span class="op">)</span>,
                   highest_educ <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">$</span><span class="va">highest_educ</span><span class="op">)</span>,
                   state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">shape_survey</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>,
                   y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"no"</span>,<span class="st">"yes"</span><span class="op">)</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="st">"wt"</span>,
  design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ids <span class="op">=</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>

<span class="co"># print it</span>
<span class="va">box_pref</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Survey with 500 observations, 6 questions </span>
<span class="co">#&gt; Independent Sampling design (with replacement) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: age </span>
<span class="co">#&gt; Question: Please identify your age group </span>
<span class="co">#&gt; Allowed answers: 18-25, 26-35, 36-45, 46-55, 56-65, 66-75, 76-90 </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: gender </span>
<span class="co">#&gt; Question: Please select your gender </span>
<span class="co">#&gt; Allowed answers: male, female, nonbinary </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: highest_educ </span>
<span class="co">#&gt; Question: Please identify your completed highest education </span>
<span class="co">#&gt; Allowed answers: no high school, high school, some college, associates, 4-year college, post-graduate </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: state </span>
<span class="co">#&gt; Question: Which State do you live in? </span>
<span class="co">#&gt; Allowed answers: State A, State B, State C, State D, State E </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: vote_for </span>
<span class="co">#&gt; Question: Which party did you vote for in the 2018 election? </span>
<span class="co">#&gt; Allowed answers: Box Party, BP, Circle Party, CP </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: y </span>
<span class="co">#&gt; Question: If today is election day, will you vote for the Box Party? </span>
<span class="co">#&gt; Allowed answers: no, yes</span></pre></div>
</div>
<div id="create-the-surveydata-object-for-the-post-stratification-dataset" class="section level4">
<h4 class="hasAnchor">
<a href="#create-the-surveydata-object-for-the-post-stratification-dataset" class="anchor"></a>Create the <code>SurveyData</code> object for the post-stratification dataset</h4>
<p>The following code is used to create SurveyData object for post-stratification data when the weight is already specified in the datasets. Usually, the post-stratification data is from a large survey, for example, the American Community Survey (ACS) or Demographic and Health Survey (DHS).</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">popn_obj</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SurveyData.html">SurveyData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">approx_voters_popn</span>,
  questions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="st">"Which age group are you?"</span>,
                gender <span class="op">=</span> <span class="st">"Which gender are you identified?"</span>,
                vote_pref <span class="op">=</span> <span class="st">"Which party do you prefer to vote?"</span>,
                education <span class="op">=</span> <span class="st">"What is the highest grade or level of school you have completed"</span>,
                state <span class="op">=</span> <span class="st">"Please identify the state where you live in"</span><span class="op">)</span>,
  responses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">age_group</span><span class="op">)</span>,
                   gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span>,
                   vote_pref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">vote_pref</span><span class="op">)</span>,
                   education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">education</span><span class="op">)</span>,
                   state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">state</span><span class="op">)</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="st">"wt"</span>,
  design <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ids <span class="op">=</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># print it</span>
<span class="va">popn_obj</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span> 
<span class="co">#&gt; Survey with 5000 observations, 5 questions </span>
<span class="co">#&gt; Independent Sampling design (with replacement) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: age_group </span>
<span class="co">#&gt; Question: Which age group are you? </span>
<span class="co">#&gt; Allowed answers: 18-35, 36-55, 56-65, 66+ </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: education </span>
<span class="co">#&gt; Question: What is the highest grade or level of school you have completed </span>
<span class="co">#&gt; Allowed answers: no high school, high school, some college, 4-years college, post-grad </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: gender </span>
<span class="co">#&gt; Question: Which gender are you identified? </span>
<span class="co">#&gt; Allowed answers: m, f, nb </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: state </span>
<span class="co">#&gt; Question: Please identify the state where you live in </span>
<span class="co">#&gt; Allowed answers: A, B, C, D, E </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: vote_pref </span>
<span class="co">#&gt; Question: Which party do you prefer to vote? </span>
<span class="co">#&gt; Allowed answers: BP, CP</span></pre></div>
<p>The following code demonstrates (optional) weights specification if weights are not included in the dataset via summarizing the post-stratification matrix. Also, here the survey design is not specified.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">

<span class="co"># Create the weight as the sum of each post-stratification cell</span>
<span class="va">popn_poststrat</span> <span class="op">&lt;-</span> <span class="va">approx_voters_popn</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age_group</span>, <span class="va">gender</span>, <span class="va">vote_pref</span>, <span class="va">education</span>, <span class="va">state</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>N_j <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">wt</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; `summarise()` has grouped output by 'age_group', 'gender', 'vote_pref', 'education'. You can override using the `.groups` argument.</span>

<span class="co"># create the SurveyData object and set the weight as N_j</span>
<span class="va">popn_obj_poststrat</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SurveyData.html">SurveyData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">popn_poststrat</span>,
  questions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="st">"Which age group are you?"</span>,
                gender <span class="op">=</span> <span class="st">"Which gender are you identified?"</span>,
                vote_pref <span class="op">=</span> <span class="st">"Which party do you prefer to vote?"</span>,
                education <span class="op">=</span> <span class="st">"What is the highest grade or level of school you have completed"</span>,
                state <span class="op">=</span> <span class="st">"Please identify the state where you live in"</span><span class="op">)</span>,
  responses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">age_group</span><span class="op">)</span>,
                   gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span>,
                   vote_pref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">vote_pref</span><span class="op">)</span>,
                   education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">education</span><span class="op">)</span>,
                   state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">state</span><span class="op">)</span><span class="op">)</span>,
  weights <span class="op">=</span> <span class="st">"N_j"</span>
<span class="op">)</span>

<span class="va">popn_obj_poststrat</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Survey with 428 observations, 5 questions </span>
<span class="co">#&gt; Independent Sampling design (with replacement) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: age_group </span>
<span class="co">#&gt; Question: Which age group are you? </span>
<span class="co">#&gt; Allowed answers: 18-35, 36-55, 56-65, 66+ </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: education </span>
<span class="co">#&gt; Question: What is the highest grade or level of school you have completed </span>
<span class="co">#&gt; Allowed answers: no high school, high school, some college, 4-years college, post-grad </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: gender </span>
<span class="co">#&gt; Question: Which gender are you identified? </span>
<span class="co">#&gt; Allowed answers: m, f, nb </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: state </span>
<span class="co">#&gt; Question: Please identify the state where you live in </span>
<span class="co">#&gt; Allowed answers: A, B, C, D, E </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: vote_pref </span>
<span class="co">#&gt; Question: Which party do you prefer to vote? </span>
<span class="co">#&gt; Allowed answers: BP, CP</span></pre></div>
<p>If the population data uses the entire individual level, then the weight should not be specified, as shown in this example.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">popn_obj_entire_ind</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SurveyData.html">SurveyData</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">popn_poststrat</span>,
  questions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="st">"Which age group are you?"</span>,
                gender <span class="op">=</span> <span class="st">"Which gender are you identified?"</span>,
                vote_pref <span class="op">=</span> <span class="st">"Which party do you prefer to vote?"</span>,
                education <span class="op">=</span> <span class="st">"What is the highest grade or level of school you have completed"</span>,
                state <span class="op">=</span> <span class="st">"Please identify the state where you live in"</span><span class="op">)</span>,
  responses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>age_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">age_group</span><span class="op">)</span>,
                   gender <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">gender</span><span class="op">)</span>,
                   vote_pref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">vote_pref</span><span class="op">)</span>,
                   education <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">education</span><span class="op">)</span>,
                   state <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">approx_voters_popn</span><span class="op">$</span><span class="va">state</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span>
<span class="co">#&gt; Warning: 'Weights have not been provided, assume all data weighted with weight</span>
<span class="co">#&gt; 1.</span>

<span class="va">popn_obj_entire_ind</span><span class="op">$</span><span class="fu">print</span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; Survey with 428 observations, 5 questions </span>
<span class="co">#&gt; Independent Sampling design (with replacement) </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: age_group </span>
<span class="co">#&gt; Question: Which age group are you? </span>
<span class="co">#&gt; Allowed answers: 18-35, 36-55, 56-65, 66+ </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: education </span>
<span class="co">#&gt; Question: What is the highest grade or level of school you have completed </span>
<span class="co">#&gt; Allowed answers: no high school, high school, some college, 4-years college, post-grad </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: gender </span>
<span class="co">#&gt; Question: Which gender are you identified? </span>
<span class="co">#&gt; Allowed answers: m, f, nb </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: state </span>
<span class="co">#&gt; Question: Please identify the state where you live in </span>
<span class="co">#&gt; Allowed answers: A, B, C, D, E </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Column label: vote_pref </span>
<span class="co">#&gt; Question: Which party do you prefer to vote? </span>
<span class="co">#&gt; Allowed answers: BP, CP</span></pre></div>
<p>In addition, sometimes, we want to access the properties of the <code>SurveyData</code> object, for example, the weights, the design, the questions and the number of questions, or the responses. The <code>SurveyData</code> object has methods that allow us to do so. They are <code>SurveyData$weights()</code>, <code>SurveyData$design()</code>, <code>SurveyData$questions()</code>, <code>SurveyData$n_questions()</code>, <code>SurveyData$responses()</code>.</p>
</div>
</div>
<div id="map-the-values-between-survey-and-post-stratification-data-using-questionmap-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#map-the-values-between-survey-and-post-stratification-data-using-questionmap-objects" class="anchor"></a>Map the values between survey and post-stratification data using <code>QuestionMap</code> objects</h2>
<p>From the metadata above, we can see that the survey (<code>box_pref</code>) and population (<code>popn_obj</code>) objects have different column labels and response levels. For example, the column label for age in <code>box_pref</code> is <code>age</code>, whereas, in <code>popn_obj</code>, the column label is <code>age_group</code>. This variable also has different levels, <code>box_pref</code> has seven levels of age, whereas <code>popn_obj</code> has only four levels of age.</p>
<p>These column labels and levels should be aligned to be able to perform MRP. With <code>QuestionMap$new</code> method, we are able to align the names of the columns and mapping their values.</p>
<p>This method takes three arguments:</p>
<ol style="list-style-type: decimal">
<li>
<code>name</code> : the name of the underlying construct. This will be used in the modeling stage.</li>
<li>
<code>col_names</code>: a character vector of the column label in the survey and post-stratification objects. Note that, column name of the survey should always be the first element, followed by the column name of the post-stratification object. This order is not interchangeable.<br>
</li>
<li>
<code>values_map</code>: list of the mapped values between the survey and post-stratification object. If there is a meaningful ordering over the values, they should be sorted over that order, either descending or ascending.</li>
</ol>
<p>Here is an example of how this method works:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co"># create QuestionMap$object for the question related to age</span>
<span class="va">q_age</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"age"</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"age"</span>,<span class="st">"age_group"</span><span class="op">)</span>,
  values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
    <span class="st">"18-25"</span> <span class="op">=</span> <span class="st">"18-35"</span>, <span class="st">"26-35"</span> <span class="op">=</span> <span class="st">"18-35"</span>, <span class="st">"36-45"</span> <span class="op">=</span> <span class="st">"36-55"</span>,
    <span class="st">"46-55"</span> <span class="op">=</span> <span class="st">"36-55"</span>, <span class="st">"56-65"</span> <span class="op">=</span> <span class="st">"56-65"</span>, <span class="st">"66-75"</span> <span class="op">=</span> <span class="st">"66+"</span>, <span class="st">"76-90"</span> <span class="op">=</span> <span class="st">"66+"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create QuestionMap$object for the question related to party preference</span>
<span class="va">q_party_pref</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
 name <span class="op">=</span> <span class="st">"party_pref"</span>,
 col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"vote_for"</span>,<span class="st">"vote_pref"</span><span class="op">)</span>,
 values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"Box Party"</span> <span class="op">=</span> <span class="st">"BP"</span>, <span class="st">"BP"</span> <span class="op">=</span> <span class="st">"BP"</span>, <span class="st">"Circle Party"</span> <span class="op">=</span> <span class="st">"CP"</span>, <span class="st">"CP"</span> <span class="op">=</span> <span class="st">"CP"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create QuestionMap$object for the question related to gender</span>
<span class="va">q_gender</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"gender"</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gender"</span>, <span class="st">"gender"</span><span class="op">)</span>,
  values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"male"</span> <span class="op">=</span> <span class="st">"m"</span>, <span class="st">"female"</span> <span class="op">=</span> <span class="st">"f"</span>, <span class="st">"nonbinary"</span> <span class="op">=</span> <span class="st">"nb"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create QuestionMap$object for the question related to education</span>
<span class="va">q_educ</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"highest_education"</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"highest_educ"</span>, <span class="st">"education"</span><span class="op">)</span>,
  values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"no high school"</span> <span class="op">=</span> <span class="st">"no high school"</span>,
                    <span class="st">"high school"</span> <span class="op">=</span> <span class="st">"high school"</span>,
                    <span class="st">"some college"</span> <span class="op">=</span> <span class="st">"some college"</span>,
                    <span class="st">"associates"</span> <span class="op">=</span> <span class="st">"some college"</span>,
                    <span class="st">"4-year college"</span> <span class="op">=</span> <span class="st">"4-years college"</span>,
                    <span class="st">"post-graduate"</span> <span class="op">=</span> <span class="st">"post-grad"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># create QuestionMap$object for the question related to state</span>
<span class="va">q_state</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"state"</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"state"</span>, <span class="st">"state"</span><span class="op">)</span>,
  values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"State A"</span> <span class="op">=</span> <span class="st">"A"</span>,
                    <span class="st">"State B"</span> <span class="op">=</span> <span class="st">"B"</span>,
                    <span class="st">"State C"</span> <span class="op">=</span> <span class="st">"C"</span>,
                    <span class="st">"State D"</span> <span class="op">=</span> <span class="st">"D"</span>,
                    <span class="st">"State E"</span> <span class="op">=</span> <span class="st">"E"</span><span class="op">)</span><span class="op">)</span></pre></div>
</div>
<div id="using-the-surveymap-object" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-surveymap-object" class="anchor"></a>Using the SurveyMap object</h2>
<p>The <code>SurveyMap</code> object holds the mapping between a set of items in the survey and post-stratification datasets. It takes the <code>SurveyData</code> objects, which in this case are <code>bp_pref</code> and <code>popn_obj</code>, together with labels and values that have been matched and provided in the <code>QuestionMap</code> objects. The mapped object would specify the correspondences in the variables that will be used when fitting the model.</p>
<p>The <code>SurveyMap</code> object has various methods as listed as follows:</p>
<ol style="list-style-type: decimal">
<li>
<p><code>SurveyMap$new</code></p>
<p>This method is used to initialize a new <code>SurveyMap</code> object. This takes <code>SurveyData</code> and <code>QuestionMap</code> objects as its argument. You can include all of the questions here, or add it incrementally using <code>add</code> method that is explained in point 2.</p>
</li>
</ol>
<div class="sourceCode" id="cb9"><pre class="downlit">

<span class="co"># create a new SurveyMap object</span>
<span class="va">ex_map</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/SurveyMap.html">SurveyMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>sample <span class="op">=</span> <span class="va">box_pref</span>, population <span class="op">=</span> <span class="va">popn_obj</span>, <span class="va">q_age</span><span class="op">)</span>
<span class="co">#&gt; Warning: Variable(s) 'gender', 'vote_pref', 'education', 'state' are available</span>
<span class="co">#&gt; in the population but won't be used in the model</span>

<span class="co"># example of mapping all of the questions at once </span>
<span class="co"># ex_map &lt;- SurveyMap$new(sample = box_pref, population = popn_obj, </span>
<span class="co">#                        q_age, q_educ, q_gender, q_party_pref, q_state)</span></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$add</code></p>
<p>To get rid of the warning above, we could use this method to add other <code>QuestionMap</code> objects to the map.</p>
</li>
</ol>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># add questions incrementally</span>
<span class="va">ex_map</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">q_educ</span><span class="op">)</span>
<span class="co">#&gt; Warning: Variable(s) 'gender', 'vote_pref', 'state' are available in the</span>
<span class="co">#&gt; population but won't be used in the model</span>
<span class="va">ex_map</span><span class="op">$</span><span class="fu">add</span><span class="op">(</span><span class="va">q_gender</span>, <span class="va">q_party_pref</span>, <span class="va">q_state</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ex_map</span><span class="op">)</span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; age = age_group </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; 18-25 = 18-35 </span>
<span class="co">#&gt; 26-35 = 18-35 </span>
<span class="co">#&gt; 36-45 = 36-55 </span>
<span class="co">#&gt; 46-55 = 36-55 </span>
<span class="co">#&gt; 56-65 = 56-65 </span>
<span class="co">#&gt; 66-75 = 66+ </span>
<span class="co">#&gt; 76-90 = 66+ </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; highest_educ = education </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; no high school = no high school </span>
<span class="co">#&gt; high school = high school </span>
<span class="co">#&gt; some college = some college </span>
<span class="co">#&gt; associates = some college </span>
<span class="co">#&gt; 4-year college = 4-years college </span>
<span class="co">#&gt; post-graduate = post-grad </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; gender = gender </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; male = m </span>
<span class="co">#&gt; female = f </span>
<span class="co">#&gt; nonbinary = nb </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; vote_for = vote_pref </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; Box Party = BP </span>
<span class="co">#&gt; BP = BP </span>
<span class="co">#&gt; Circle Party = CP </span>
<span class="co">#&gt; CP = CP </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; state = state </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; State A = A </span>
<span class="co">#&gt; State B = B </span>
<span class="co">#&gt; State C = C </span>
<span class="co">#&gt; State D = D </span>
<span class="co">#&gt; State E = E</span></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$delete</code></p>
<p>Now, we already have all of the questions in the post-stratification object mapped. Sometimes, we do not want to include all of the variables in the post-stratification matrix. For example, in this case, we want to exclude <code>party_pref</code> from the matrix using <code>delete</code> method.</p>
</li>
</ol>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="co"># we can also use the label instead of the object name</span>
<span class="va">ex_map</span><span class="op">$</span><span class="fu">delete</span><span class="op">(</span><span class="st">"party_pref"</span><span class="op">)</span>
<span class="co">#&gt; Warning: Variable(s) 'vote_pref' are available in the population but won't be</span>
<span class="co">#&gt; used in the model</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ex_map</span><span class="op">)</span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; age = age_group </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; 18-25 = 18-35 </span>
<span class="co">#&gt; 26-35 = 18-35 </span>
<span class="co">#&gt; 36-45 = 36-55 </span>
<span class="co">#&gt; 46-55 = 36-55 </span>
<span class="co">#&gt; 56-65 = 56-65 </span>
<span class="co">#&gt; 66-75 = 66+ </span>
<span class="co">#&gt; 76-90 = 66+ </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; highest_educ = education </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; no high school = no high school </span>
<span class="co">#&gt; high school = high school </span>
<span class="co">#&gt; some college = some college </span>
<span class="co">#&gt; associates = some college </span>
<span class="co">#&gt; 4-year college = 4-years college </span>
<span class="co">#&gt; post-graduate = post-grad </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; gender = gender </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; male = m </span>
<span class="co">#&gt; female = f </span>
<span class="co">#&gt; nonbinary = nb </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; state = state </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; State A = A </span>
<span class="co">#&gt; State B = B </span>
<span class="co">#&gt; State C = C </span>
<span class="co">#&gt; State D = D </span>
<span class="co">#&gt; State E = E</span></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$replace</code></p>
<p>Suppose that you changed your mind and want to use another level of matching for a certain question. For example, in question regarding education, q4, you want to change the “associates” level to be equal to “4-years college”. To do this, you can firstly create a new <code>QuestionMap</code> object corresponding to that new level mapping. Secondly, you can use the <code>replace</code> method to change the question object. This method takes two arguments, namely <code>old question</code> as the first argument and the <code>new question</code> as the second argument.</p>
</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="co"># create a new QuestionMap corresponding to the new level matching</span>
<span class="va">q_educ_new</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/QuestionMap.html">QuestionMap</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"highest_educ"</span>,
  col_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"highest_educ"</span>, <span class="st">"education"</span><span class="op">)</span>,
  values_map <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"no high school"</span> <span class="op">=</span> <span class="st">"no high school"</span>,
                    <span class="st">"high school"</span> <span class="op">=</span> <span class="st">"high school"</span>,
                    <span class="st">"some college"</span> <span class="op">=</span> <span class="st">"some college"</span>,
                    <span class="st">"associates"</span> <span class="op">=</span> <span class="st">"4-years college"</span>,
                    <span class="st">"4-year college"</span> <span class="op">=</span> <span class="st">"4-years college"</span>,
                    <span class="st">"post-graduate"</span> <span class="op">=</span> <span class="st">"post-grad"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># replace the old question with new question</span>
<span class="va">ex_map</span><span class="op">$</span><span class="fu">replace</span><span class="op">(</span><span class="va">q_educ</span>, <span class="va">q_educ_new</span><span class="op">)</span>
<span class="co">#&gt; Warning: Variable(s) 'vote_pref', 'education' are available in the population</span>
<span class="co">#&gt; but won't be used in the model</span>
<span class="co">#&gt; Warning: Variable(s) 'vote_pref' are available in the population but won't be</span>
<span class="co">#&gt; used in the model</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ex_map</span><span class="op">)</span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; age = age_group </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; 18-25 = 18-35 </span>
<span class="co">#&gt; 26-35 = 18-35 </span>
<span class="co">#&gt; 36-45 = 36-55 </span>
<span class="co">#&gt; 46-55 = 36-55 </span>
<span class="co">#&gt; 56-65 = 56-65 </span>
<span class="co">#&gt; 66-75 = 66+ </span>
<span class="co">#&gt; 76-90 = 66+ </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; gender = gender </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; male = m </span>
<span class="co">#&gt; female = f </span>
<span class="co">#&gt; nonbinary = nb </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; state = state </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; State A = A </span>
<span class="co">#&gt; State B = B </span>
<span class="co">#&gt; State C = C </span>
<span class="co">#&gt; State D = D </span>
<span class="co">#&gt; State E = E </span>
<span class="co">#&gt; ============== </span>
<span class="co">#&gt; highest_educ = education </span>
<span class="co">#&gt; -------------- </span>
<span class="co">#&gt; no high school = no high school </span>
<span class="co">#&gt; high school = high school </span>
<span class="co">#&gt; some college = some college </span>
<span class="co">#&gt; associates = 4-years college </span>
<span class="co">#&gt; 4-year college = 4-years college </span>
<span class="co">#&gt; post-graduate = post-grad</span></pre></div>
<ol start="5" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$mapping</code></p>
<p>Once you are happy with your map object, you can prepare the mapped data for model fitting with the <code>mapping</code> method.</p>
</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">ex_map</span><span class="op">$</span><span class="fu">mapping</span><span class="op">(</span><span class="op">)</span></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$tabulate</code></p>
<p>The next step is to prepare the post-stratification table using the <code>tabulate</code> method. If you want to only use a certain variable in the post-stratification matrix, then you should put that variable as the argument. For instance, here, we only use <code>age</code> in the post-stratification matrix.</p>
</li>
</ol>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">ex_map</span><span class="op">$</span><span class="fu">tabulate</span><span class="op">(</span><span class="st">"age"</span><span class="op">)</span></pre></div>
<p>If you want to include all of the variables in the post-stratification matrix, then the method should not take any arguments.</p>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="va">ex_map</span><span class="op">$</span><span class="fu">tabulate</span><span class="op">(</span><span class="op">)</span></pre></div>
<ol start="7" style="list-style-type: decimal">
<li>
<p><code>SurveyMap$fit</code></p>
<p>Finally, we are able to fit the model using <code>fit</code> method. Currently, this package supports <code><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">rstanarm::stan_glmer</a></code> and <code><a href="https://mc-stan.org/rstanarm/reference/stan_glm.html">rstanarm::stan_glm</a></code> (Goodrich, Gabry, Ali, &amp; Brilleman, 2020), <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">lme4::glmer</a></code> (Bates, Maechler, Bolker, &amp; Walker, 2015) , <code><a href="https://rdrr.io/pkg/brms/man/brm.html">brms::brm</a></code> (Bürkner, 2018) as the built-in functions. However, you could also specify your own function. In this case, you should give a <code>data</code> argument that accepts a data frame. In this example, we fit three models using <code>fun=rstanarm::stan_glmer</code>, <code>fun=lme4::glmer</code>, and <code>fun=brms:brm</code> with <code>age</code>, <code>gender</code>, and <code>education</code> as the predictors.</p>
</li>
</ol>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="co"># example of using rstanarm::stan_glmer</span>
<span class="va">fit1</span> <span class="op">&lt;-</span> <span class="va">ex_map</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>
  fun <span class="op">=</span> <span class="fu">rstanarm</span><span class="fu">::</span><span class="va"><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">stan_glmer</a></span>,
  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gender</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">highest_educ</span><span class="op">)</span>,
  family <span class="op">=</span> <span class="st">"binomial"</span>,
  refresh <span class="op">=</span> <span class="fl">100</span>,
  cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># example of using lme4::glmer</span>
<span class="va">fit2</span> <span class="op">&lt;-</span> <span class="va">ex_map</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>
  fun <span class="op">=</span> <span class="fu">lme4</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/lme4/man/glmer.html">glmer</a></span>,
  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gender</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">highest_educ</span><span class="op">)</span>,
  family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># example using brms::brm</span>
<span class="va">fit3</span> <span class="op">&lt;-</span> <span class="va">ex_map</span><span class="op">$</span><span class="fu">fit</span><span class="op">(</span>
  fun <span class="op">=</span> <span class="fu">brms</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/brms/man/brm.html">brm</a></span>,
  formula <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">gender</span><span class="op">)</span>,
  family <span class="op">=</span> <span class="st">"bernoulli"</span>,
  refresh <span class="op">=</span> <span class="fl">100</span>,
  cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></pre></div>
<p>The resulting object is <em>not</em> simply the fitted model object created by the modeling function, but rather a <code>SurveyFit</code> object that contains the fitted model and provides useful methods for working with it.</p>
</div>
<div id="using-the-surveyfit-object" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-surveyfit-object" class="anchor"></a>Using the <code>SurveyFit</code> object</h2>
<p>In this stage, we already have the fitted model object, i.e., <code>fit1</code> and <code>fit2</code>. These objects have been automatically stored as <code>SurveyFit</code> objects. Using this object we can generate the predicted probabilities for all post-stratification cells, aggregate the small area estimation, for example, state or province estimates, and visualize the aggregated estimates.</p>
<div id="get-the-probability-of-the-outcome-from-each-poststratification-cells" class="section level3">
<h3 class="hasAnchor">
<a href="#get-the-probability-of-the-outcome-from-each-poststratification-cells" class="anchor"></a>Get the probability of the outcome from each poststratification cells</h3>
<p>After creating the <code>SurveyFit</code> object, we are able to generate the predicted probability of the outcome of each post-stratification cell using the <code>SurveyFit$population_predict</code> method. It returns a matrix with rows that correspond to the columns of post-stratification data and columns that correspond to the posterior samples.</p>
<p>Furthermore, if the model fitting is done with one of the built-in functions (<code><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">rstanarm::stan_glmer</a></code>, <code><a href="https://rdrr.io/pkg/lme4/man/glmer.html">lme4::glmer</a></code>, <code><a href="https://rdrr.io/pkg/brms/man/brm.html">brms::brm</a></code>), then this method does not take any arguments. However, if you used a customized function in the model fitting, then this method takes multiple arguments, including a custom prediction function (see ?SurveyFit for details). In this example, we will show how to use this method for the <code>fit1</code> object created using <code><a href="https://mc-stan.org/rstanarm/reference/stan_glmer.html">rstanarm::stan_glmer</a></code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="co"># predict the probability of voting for the Box Party using the fit1 model</span>
<span class="va">poststrat_est_fit1</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">population_predict</span><span class="op">(</span><span class="op">)</span></pre></div>
</div>
<div id="aggregate-the-probbility-of-the-outcome-to-a-higher-level-of-estimate" class="section level3">
<h3 class="hasAnchor">
<a href="#aggregate-the-probbility-of-the-outcome-to-a-higher-level-of-estimate" class="anchor"></a>Aggregate the probbility of the outcome to a higher level of estimate</h3>
<p>The next step is to generate the population estimate or group estimate using the <code>SurveyFit$aggregate</code> method. This method takes two arguments, namely the post-stratification estimate data and the variable whose level to which the estimated value would be aggregated to. In this example, we want to aggregate the estimated value by the level of <code>age</code> and <code>state</code>. If the variable is not specified, then this method would generate a population estimate.</p>
<div class="sourceCode" id="cb19"><pre class="downlit">

<span class="co"># aggregate the predicted value by age</span>
<span class="va">age_estimation</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">poststrat_est_fit1</span>, by <span class="op">=</span> <span class="st">"age"</span><span class="op">)</span>

<span class="co"># aggregate the predicted value by state</span>
<span class="va">state_estimation</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">poststrat_est_fit1</span>, by <span class="op">=</span> <span class="st">"state"</span><span class="op">)</span>

<span class="co"># generate the population estimate</span>
<span class="va">popn_estimation</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">aggregate</span><span class="op">(</span><span class="va">poststrat_est_fit1</span><span class="op">)</span></pre></div>
<p>This method then will return a data frame with the variable levels and probability of the outcome, <code>y</code>. In this example, <code>age_estimation</code> represents the age group and the probability of voting for the Box Party for each age group. You can also get the mean of the probability of voting the BP by age group and its standard deviation with the help of <code>summarize</code> function from <code>dplyr</code> (Wickham, François, Henry &amp; Müller, 2020) using the code as follows.</p>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">age_estimation</span><span class="op">)</span> 
<span class="co">#&gt;             age     value</span>
<span class="co">#&gt; 1 18-25 + 26-35 0.7197018</span>
<span class="co">#&gt; 2 36-45 + 46-55 0.7132751</span>
<span class="co">#&gt; 3         56-65 0.7271213</span>
<span class="co">#&gt; 4 66-75 + 76-90 0.6928325</span>
<span class="co">#&gt; 5 18-25 + 26-35 0.7151023</span>
<span class="co">#&gt; 6 36-45 + 46-55 0.7088473</span>

<span class="co"># get the mean and sd for each age group</span>

<span class="va">age_estimation</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">age</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 4 x 3</span>
<span class="co">#&gt;   age            mean     sd</span>
<span class="co">#&gt;   &lt;fct&gt;         &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt; 1 18-25 + 26-35 0.692 0.0642</span>
<span class="co">#&gt; 2 36-45 + 46-55 0.755 0.0316</span>
<span class="co">#&gt; 3 56-65         0.746 0.0295</span>
<span class="co">#&gt; 4 66-75 + 76-90 0.718 0.0350</span></pre></div>
</div>
<div id="visualize-it" class="section level3">
<h3 class="hasAnchor">
<a href="#visualize-it" class="anchor"></a>Visualize it</h3>
<p>Once we have the aggregated estimates, we are able to visualize them using the <code>plot</code> method. This method takes the aggregated data frame and weights option (the default is TRUE) as its arguments. It generates a violin plot of the aggregated estimate by the level of a certain variable. When the weight is equal to TRUE, the estimation is weighted. Also, the plot would display the 95% confidence interval of the weighted estimation. In this example, we display the estimated plot for <code>age</code> and <code>state</code> and a density plot for the population estimates.</p>
<div class="sourceCode" id="cb21"><pre class="downlit">
<span class="va">plot_age</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="va">age_estimation</span><span class="op">)</span> 
<span class="va">plot_age</span></pre></div>
<p><img src="mrpkit_workflow_files/figure-html/age-vis-1.png" width="700"></p>
<p>The plot above shows the distribution of people who vote for the Box Party for each age group. The plot implies that people who are aged 36-55 are most likely to vote for the BP.</p>
<p>The next plot displays the probability of voting for the BP by the state without using the weight. We learn that the probability of the BP winning the election is high since the majority of people in all states (around 75%) vote for that party. Note that this violin plot is generated using <code>ggplot2</code> (Wickham, 2016). Hence, it could be modified the same way <code>ggplot2</code>’s plot is modified. For example, here, we can add the title and change the theme of the plot.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">plot_state</span> <span class="op">&lt;-</span> <span class="va">fit1</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="va">state_estimation</span>, weights <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Probability of voting the BP by state"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">plot_state</span></pre></div>
<p><img src="mrpkit_workflow_files/figure-html/state-vis-1.png" width="700"></p>
<p>Lastly, we show the plot of the population estimate. About 70% of people in the Shape World will be likely to vote for the Box Party.</p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="va">fit1</span><span class="op">$</span><span class="fu">plot</span><span class="op">(</span><span class="va">popn_estimation</span>, weights <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></pre></div>
<p><img src="mrpkit_workflow_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Bates, D., Maechler, M., Bolker, B., &amp; Walker, S. (2015). Fitting Linear Mixed-Effects Models Using lme4. Journal of Statistical Software, 67(1), 1-48. :10.18637/jss.v067.i01.</p>
<p>Blair, G., Cooper, J., Coppock, A., &amp; Humphreys, M. (2019). Declaring and Diagnosing Research Designs. American Political Science Review 113(3): 838-859. URL <a href="http://declaredesign.org/declare.pdf" class="uri">http://declaredesign.org/declare.pdf</a></p>
<p>Bürkner, P.C. (2018). Advanced Bayesian Multilevel Modeling with the R Package brms. The R Journal, 10(1), 395-411. :10.32614/RJ-2018-017</p>
<p>Chang, W. (2019). R6: Encapsulated Classes with Reference Semantics. R package version 2.4.1. <a href="https://CRAN.R-project.org/package=R6" class="uri">https://CRAN.R-project.org/package=R6</a></p>
<p>Gelman, A., &amp; Little, T. C. (1997). Poststratification into many categories using hierarchical logistic regression. Survey Methodology, 23(2), 127–135.</p>
<p>Goodrich, B., Gabry, J., Ali, I., &amp; Brilleman S. (2020). rstanarm: Bayesian applied regression modeling via Stan. R package version 2.21.1 <a href="https://mc-stan.org/rstanarm" class="uri">https://mc-stan.org/rstanarm</a>.</p>
<p>Lumley, T. (2020) “survey: analysis of complex survey samples”. R package version 4.0.</p>
<p>Park, D. K., Gelman, A., &amp; Bafumi, J. (2004). Bayesian multilevel esti- mation with poststratification: State-level estimates from national polls. Political Analysis, 12(4), 375–385.</p>
<p>R Core Team. (2020). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL <a href="https://www.R-project.org/" class="uri">https://www.R-project.org/</a>.</p>
<p>Wickham, H., François, R., Henry, L., &amp; Müller, K. (2020). dplyr: A Grammar of Data Manipulation. R package version 1.0.2. <a href="https://CRAN.R-project.org/package=dplyr" class="uri">https://CRAN.R-project.org/package=dplyr</a></p>
<p>Wickham, H. (2016). ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lauren Kennedy, Jonah Gabry, Mitzi Morris, Dewi Amaliah, Rohan Alexander.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
